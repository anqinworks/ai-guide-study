<!-- pages/statistics/statistics.wxml -->
<view class="container">
  <view class="header">
    <text class="title">å­¦ä¹ ç»Ÿè®¡</text>
    <text class="update-time" wx:if="{{dataLastUpdated}}">æ›´æ–°äº {{dataLastUpdated}}</text>
  </view>
  
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
  
  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-container" wx:if="{{error && !loading}}">
    <text class="error-icon">âš ï¸</text>
    <text class="error-text">{{error}}</text>
    <button class="retry-btn" bindtap="retryLoadData">é‡è¯•</button>
  </view>
  
  <!-- æ•°æ®å±•ç¤º -->
  <view class="data-container" wx:if="{{!loading && !error}}">
    <!-- æ ¸å¿ƒç»Ÿè®¡æŒ‡æ ‡ -->
    <view class="stats-overview">
      <view class="stat-card" style="animation-delay: 0.1s">
        <view class="stat-icon">ğŸ“Š</view>
        <text class="stat-value">{{totalQuestions}}</text>
        <text class="stat-label">ç­”é¢˜æ€»æ•°</text>
      </view>
      <view class="stat-card correct" style="animation-delay: 0.2s">
        <view class="stat-icon">âœ…</view>
        <text class="stat-value">{{correctQuestions}}</text>
        <text class="stat-label">æ­£ç¡®é¢˜æ•°</text>
      </view>
      <view class="stat-card wrong" style="animation-delay: 0.3s">
        <view class="stat-icon">âŒ</view>
        <text class="stat-value">{{wrongQuestions}}</text>
        <text class="stat-label">é”™é¢˜æ•°</text>
      </view>
      <view class="stat-card accuracy" style="animation-delay: 0.4s">
        <view class="stat-icon">ğŸ¯</view>
        <text class="stat-value">{{accuracy}}%</text>
        <text class="stat-label">æ­£ç¡®ç‡</text>
      </view>
      <view class="stat-card time" style="animation-delay: 0.5s">
        <view class="stat-icon">â±ï¸</view>
        <text class="stat-value">{{averageTime}}s</text>
        <text class="stat-label">å¹³å‡ç”¨æ—¶</text>
      </view>
      <view class="stat-card study" style="animation-delay: 0.6s">
        <view class="stat-icon">ğŸ“š</view>
        <text class="stat-value">{{totalStudyTimeMinutes}}</text>
        <text class="stat-label">å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)</text>
      </view>
    </view>
    
    <!-- æ•°æ®éªŒè¯æç¤º -->
    <view class="validation-info" wx:if="{{isDataValid && dataValidationErrors.length === 0}}">
      <text class="validation-icon">âœ…</text>
      <text class="validation-text">æ•°æ®å·²éªŒè¯ï¼Œç»Ÿè®¡å‡†ç¡®</text>
    </view>
    
    <view class="validation-warning" wx:if="{{dataValidationErrors.length > 0}}">
      <text class="validation-icon">âš ï¸</text>
      <text class="validation-text">æ£€æµ‹åˆ°æ•°æ®å¼‚å¸¸ï¼Œå·²è‡ªåŠ¨ä¿®æ­£</text>
    </view>
    
    <!-- æ ‡ç­¾åˆ‡æ¢ -->
    <view class="tabs-container" wx:if="{{totalQuestions > 0}}">
      <view class="tab-item {{activeTab === 'overview' ? 'active' : ''}}" 
            bindtap="switchTab" data-tab="overview">
        <text>æ¦‚è§ˆ</text>
      </view>
      <view class="tab-item {{activeTab === 'trend' ? 'active' : ''}}" 
            bindtap="switchTab" data-tab="trend">
        <text>å­¦ä¹ è¶‹åŠ¿</text>
      </view>
      <view class="tab-item {{activeTab === 'type' ? 'active' : ''}}" 
            bindtap="switchTab" data-tab="type">
        <text>é¢˜å‹åˆ†å¸ƒ</text>
      </view>
      <view class="tab-item {{activeTab === 'knowledge' ? 'active' : ''}}" 
            bindtap="switchTab" data-tab="knowledge">
        <text>çŸ¥è¯†æŒæ¡</text>
      </view>
    </view>
    
    <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{activeTab === 'overview' && totalQuestions > 0}}">
      <!-- å­¦ä¹ è¶‹åŠ¿å›¾è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰ -->
      <view class="chart-card" wx:if="{{trendData.length > 0}}">
        <view class="chart-header">
          <text class="chart-title">æœ€è¿‘7å¤©å­¦ä¹ è¶‹åŠ¿</text>
        </view>
        <view class="trend-chart">
          <view class="trend-item" wx:for="{{trendData}}" wx:key="date">
            <view class="trend-bar-container">
              <view class="trend-bar correct-bar" 
                    style="height: {{item.questions > 0 ? (item.correct / item.questions * 100) : 0}}%"></view>
              <view class="trend-bar wrong-bar" 
                    style="height: {{item.questions > 0 ? ((item.questions - item.correct) / item.questions * 100) : 0}}%"></view>
            </view>
            <text class="trend-label">{{item.date}}</text>
            <text class="trend-value">{{item.questions}}é¢˜</text>
          </view>
        </view>
      </view>
      
      <!-- æ­£ç¡®ç‡åˆ†å¸ƒ -->
      <view class="chart-card" wx:if="{{accuracyData.length > 0}}">
        <view class="chart-header">
          <text class="chart-title">æ­£ç¡®ç‡åˆ†å¸ƒ</text>
        </view>
        <view class="accuracy-distribution">
          <view class="accuracy-item" wx:for="{{accuracyData}}" wx:key="range" 
                bindtap="viewChartDetail" data-type="accuracy" data-item="{{item}}">
            <view class="accuracy-bar-container">
              <view class="accuracy-bar" style="width: {{item.percentage}}%"></view>
            </view>
            <text class="accuracy-label">{{item.range}}%</text>
            <text class="accuracy-count">{{item.count}}æ¬¡</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- å­¦ä¹ è¶‹åŠ¿æ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{activeTab === 'trend' && totalQuestions > 0}}">
      <view class="chart-card" wx:if="{{trendData.length > 0}}">
        <view class="chart-header">
          <text class="chart-title">æœ€è¿‘7å¤©å­¦ä¹ è¶‹åŠ¿</text>
        </view>
        <view class="trend-detail-chart">
          <view class="trend-row" wx:for="{{trendData}}" wx:key="date">
            <view class="trend-info">
              <text class="trend-date">{{item.date}}</text>
              <text class="trend-stats">{{item.questions}}é¢˜ | æ­£ç¡®{{item.correct}}é¢˜ | {{item.time}}ç§’</text>
            </view>
            <view class="trend-bar-wrapper">
              <view class="trend-progress-bar">
                <view class="trend-progress correct-progress" 
                      style="width: {{item.questions > 0 ? (item.correct / item.questions * 100) : 0}}%"></view>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å­¦ä¹ æ—¶é•¿è¶‹åŠ¿ -->
      <view class="chart-card" wx:if="{{studyTimeData.length > 0}}">
        <view class="chart-header">
          <text class="chart-title">æœ€è¿‘7å¤©å­¦ä¹ æ—¶é•¿</text>
        </view>
        <view class="study-time-chart">
          <view class="time-item" wx:for="{{studyTimeData}}" wx:key="date">
            <view class="time-bar-container">
              <view class="time-bar" 
                    style="height: {{item.time > 0 ? Math.min((item.time / 3600) * 100, 100) : 0}}%"></view>
            </view>
            <text class="time-label">{{item.date}}</text>
            <text class="time-value">{{item.timeMinutes}}åˆ†é’Ÿ</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- é¢˜å‹åˆ†å¸ƒæ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{activeTab === 'type' && totalQuestions > 0}}">
      <view class="chart-card" wx:if="{{typeData.length > 0}}">
        <view class="chart-header">
          <text class="chart-title">é¢˜å‹åˆ†å¸ƒç»Ÿè®¡</text>
        </view>
        <view class="type-distribution">
          <view class="type-item" wx:for="{{typeData}}" wx:key="type"
                bindtap="viewChartDetail" data-type="type" data-item="{{item}}">
            <view class="type-info">
              <text class="type-name">{{item.type}}</text>
              <text class="type-accuracy">æ­£ç¡®ç‡: {{item.accuracy}}%</text>
            </view>
            <view class="type-stats">
              <view class="type-bar-container">
                <view class="type-bar correct" style="width: {{item.count > 0 ? (item.correct / item.count * 100) : 0}}%"></view>
                <view class="type-bar wrong" style="width: {{item.count > 0 ? ((item.count - item.correct) / item.count * 100) : 0}}%"></view>
              </view>
              <text class="type-count">{{item.correct}}/{{item.count}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- é”™é¢˜åˆ†å¸ƒ -->
      <view class="chart-card" wx:if="{{wrongQuestionsData.length > 0}}">
        <view class="chart-header">
          <text class="chart-title">é”™é¢˜åˆ†å¸ƒï¼ˆæŒ‰ä¸»é¢˜ï¼‰</text>
        </view>
        <view class="wrong-distribution">
          <view class="wrong-item" wx:for="{{wrongQuestionsData}}" wx:key="knowledgePoint"
                bindtap="viewChartDetail" data-type="wrong" data-item="{{item}}">
            <text class="wrong-point">{{item.knowledgePoint}}</text>
            <view class="wrong-count-wrapper">
              <view class="wrong-count-bar" 
                    style="width: {{item.count > 0 ? Math.min((item.count / wrongQuestionsData[0].count) * 100, 100) : 0}}%"></view>
              <text class="wrong-count">{{item.count}}é¢˜</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- çŸ¥è¯†æŒæ¡æ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{activeTab === 'knowledge' && totalQuestions > 0}}">
      <view class="chart-card" wx:if="{{knowledgePointsData.length > 0}}">
        <view class="chart-header">
          <text class="chart-title">çŸ¥è¯†ç‚¹æŒæ¡ç¨‹åº¦</text>
        </view>
        <view class="knowledge-distribution">
          <view class="knowledge-item" wx:for="{{knowledgePointsData}}" wx:key="name"
                bindtap="viewChartDetail" data-type="knowledge" data-item="{{item}}">
            <view class="knowledge-header">
              <text class="knowledge-name">{{item.name}}</text>
              <text class="knowledge-mastery">{{item.mastery}}%</text>
            </view>
            <view class="knowledge-progress-container">
              <view class="knowledge-progress" style="width: {{item.mastery}}%"></view>
            </view>
            <view class="knowledge-detail">
              <text class="knowledge-stats">æ­£ç¡®: {{item.correct}} / æ€»è®¡: {{item.total}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ— æ•°æ®çŠ¶æ€ -->
    <view class="empty-container" wx:if="{{totalQuestions === 0}}">
      <view class="empty-icon">ğŸ“Š</view>
      <text class="empty-text">æš‚æ— ç»Ÿè®¡æ•°æ®</text>
      <text class="empty-desc">å¼€å§‹ç­”é¢˜åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºæ‚¨çš„å­¦ä¹ ç»Ÿè®¡</text>
    </view>
  </view>
</view>