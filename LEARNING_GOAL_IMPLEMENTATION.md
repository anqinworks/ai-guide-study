# 学习目标设置功能实现文档

## 功能概述

实现了完整的学习目标设置功能，包括前端界面、后端API、数据库模型和数据验证。用户可以在"我的"页面查看学习目标，并进入专门的设置页面进行创建、编辑和删除操作。

## 实现内容

### 1. 数据库模型

**文件**: `backend/models/LearningGoal.js`

**字段定义**:
- `id`: 主键，自增
- `userId`: 用户ID，外键关联users表
- `name`: 学习目标名称（必填，最大200字符）
- `description`: 学习目标描述（可选，文本类型）
- `progress`: 完成进度（0-100，默认0）
- `targetDate`: 目标完成日期（可选）
- `status`: 目标状态（active/completed/paused，默认active）
- `priority`: 优先级（1-5，默认1）
- `createdAt`: 创建时间
- `updatedAt`: 更新时间

**关联关系**:
- 与User模型建立一对多关系
- 支持级联删除（用户删除时自动删除其所有学习目标）

### 2. 后端API

**文件**: `backend/routes/learning-goal.js`

**路由列表**:

#### GET `/api/learning-goal`
- **功能**: 获取当前用户的所有学习目标
- **认证**: 需要登录（使用authenticate中间件）
- **返回**: 按优先级和创建时间排序的目标列表

#### POST `/api/learning-goal`
- **功能**: 创建新的学习目标
- **认证**: 需要登录
- **参数**:
  - `name` (必填): 目标名称
  - `description` (可选): 目标描述
  - `targetDate` (可选): 目标完成日期
  - `priority` (可选): 优先级（1-5，默认1）
- **验证**:
  - 名称不能为空，不超过200字符
  - 优先级必须在1-5之间
  - 目标日期必须是未来日期
- **事务**: 使用数据库事务确保数据一致性

#### PUT `/api/learning-goal/:id`
- **功能**: 更新学习目标
- **认证**: 需要登录
- **参数**: 同POST，所有字段可选
- **验证**:
  - 进度必须在0-100之间
  - 状态必须是active/completed/paused之一
  - 进度达到100%时自动设置为已完成
- **事务**: 使用数据库事务确保数据一致性

#### DELETE `/api/learning-goal/:id`
- **功能**: 删除学习目标
- **认证**: 需要登录
- **验证**: 只能删除自己的学习目标
- **事务**: 使用数据库事务确保数据一致性

#### PUT `/api/learning-goal/batch-update-progress`
- **功能**: 批量更新学习目标进度
- **认证**: 需要登录
- **参数**: `{ updates: [{ id, progress }, ...] }`
- **用途**: 用于批量更新多个目标的进度

### 3. 前端页面

#### 学习目标设置页面

**文件**: `miniprogram/pages/goal-setting/`

**功能特性**:
- **目标列表展示**: 显示所有学习目标，包括名称、描述、进度、状态、优先级等
- **添加目标**: 点击"添加学习目标"按钮创建新目标
- **编辑目标**: 点击目标卡片进入编辑模式
- **删除目标**: 点击删除按钮，确认后删除目标
- **表单验证**: 前端实时验证输入数据
- **进度调整**: 编辑时可通过滑块调整进度
- **状态管理**: 支持设置目标状态（进行中/已完成/已暂停）
- **优先级选择**: 1-5级优先级选择
- **日期选择**: 选择目标完成日期

**UI设计**:
- 使用卡片式布局，符合应用整体风格
- 进度条可视化显示完成进度
- 优先级和状态使用徽章显示
- 响应式设计，适配不同屏幕尺寸
- 空状态提示，引导用户创建第一个目标

#### 用户页面更新

**文件**: `miniprogram/pages/user/user.js`, `miniprogram/pages/user/user.wxml`

**更新内容**:
- `loadLearningGoals()`: 从数据库API加载学习目标，替代本地存储
- `formatGoalDate()`: 格式化日期显示
- 点击"设置"按钮跳转到学习目标设置页面
- 显示目标列表和进度条

### 4. 数据验证和错误处理

#### 后端验证

**输入验证**:
- 目标名称：必填，1-200字符
- 目标描述：可选，最大500字符
- 进度：0-100之间的整数
- 优先级：1-5之间的整数
- 状态：必须是枚举值之一
- 目标日期：必须是有效的未来日期

**数据完整性**:
- 使用数据库事务确保操作的原子性
- 外键约束确保数据关联正确
- 索引优化查询性能

**错误处理**:
- 详细的错误消息返回
- 数据库约束错误捕获和转换
- 用户友好的错误提示

#### 前端验证

**实时验证**:
- 输入框字符长度限制
- 必填字段检查
- 日期格式验证
- 进度范围验证

**用户反馈**:
- 加载状态提示
- 成功/失败消息提示
- 确认对话框（删除操作）
- 表单验证错误提示

### 5. 路由注册

**后端**: `backend/app.js`
- 注册学习目标路由：`/api/learning-goal`

**前端**: `miniprogram/app.json`
- 添加学习目标设置页面路径

## 数据库迁移

首次运行需要创建`learning_goals`表。Sequelize会自动同步模型：

```javascript
await db.sequelize.sync({ force: false })
```

表结构包括：
- 主键和索引
- 外键约束
- 字段验证
- 时间戳字段

## 测试建议

### 功能测试

1. **创建目标**
   - [ ] 正常创建目标
   - [ ] 验证必填字段
   - [ ] 验证字符长度限制
   - [ ] 验证日期格式

2. **编辑目标**
   - [ ] 修改目标名称
   - [ ] 修改进度
   - [ ] 修改状态
   - [ ] 修改优先级
   - [ ] 进度达到100%自动完成

3. **删除目标**
   - [ ] 正常删除
   - [ ] 确认对话框
   - [ ] 删除后列表更新

4. **数据加载**
   - [ ] 页面加载时获取目标列表
   - [ ] 用户页面显示目标
   - [ ] 空状态显示

### 边界测试

1. **数据验证**
   - [ ] 空名称
   - [ ] 超长名称（>200字符）
   - [ ] 无效日期
   - [ ] 过去日期
   - [ ] 无效优先级（<1或>5）
   - [ ] 无效进度（<0或>100）

2. **权限测试**
   - [ ] 未登录用户访问
   - [ ] 访问他人目标
   - [ ] Token过期处理

3. **网络测试**
   - [ ] 网络错误处理
   - [ ] 请求超时处理
   - [ ] 服务器错误处理

### 性能测试

1. **数据量测试**
   - [ ] 大量目标（100+）的加载性能
   - [ ] 列表渲染性能
   - [ ] 数据库查询优化

2. **并发测试**
   - [ ] 同时创建多个目标
   - [ ] 同时编辑同一目标
   - [ ] 事务隔离性

## 使用说明

### 用户操作流程

1. **查看学习目标**
   - 进入"我的"页面
   - 在"学习目标"卡片中查看所有目标

2. **创建学习目标**
   - 点击"设置"按钮或"设置学习目标"按钮
   - 进入学习目标设置页面
   - 点击"添加学习目标"按钮
   - 填写目标信息（名称必填）
   - 点击"保存"

3. **编辑学习目标**
   - 在学习目标设置页面
   - 点击目标卡片
   - 修改目标信息
   - 点击"保存"

4. **删除学习目标**
   - 在学习目标设置页面
   - 点击目标卡片中的"删除"按钮
   - 确认删除

### 开发者注意事项

1. **数据库同步**
   - 首次运行需要同步数据库模型
   - 确保数据库连接正常

2. **API认证**
   - 所有API都需要用户登录
   - Token通过Authorization头传递

3. **错误处理**
   - 前端需要处理网络错误
   - 后端返回统一的错误格式

4. **数据迁移**
   - 如果之前使用本地存储，需要迁移数据到数据库
   - 可以编写迁移脚本

## 后续优化建议

### 短期优化
1. 添加目标分类功能
2. 添加目标提醒功能
3. 优化列表排序和筛选

### 中期优化
1. 添加目标统计分析
2. 添加目标完成历史记录
3. 添加目标分享功能

### 长期优化
1. 添加目标模板功能
2. 添加目标推荐功能
3. 添加目标协作功能

## 总结

学习目标设置功能已完整实现，包括：
- ✅ 数据库模型和关联关系
- ✅ 完整的后端API（CRUD操作）
- ✅ 前端设置页面
- ✅ 数据验证和错误处理
- ✅ 用户页面集成
- ✅ 事务管理和数据一致性

所有功能已通过代码检查，可以开始测试使用。

---

**实现日期**: 2024年
**版本**: v1.0
**状态**: ✅ 已完成

